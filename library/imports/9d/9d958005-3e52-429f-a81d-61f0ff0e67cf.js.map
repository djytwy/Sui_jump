{"version":3,"sources":["assets/scripts/UtilsCommon.js"],"names":["UtilsCommon","cc","Class","Component","statics","_cameraMain","getCameraMain","find","getComponent","Camera","getScreenshotBase64","camera","texture","RenderTexture","gl","game","_renderContext","initWithSize","visibleRect","width","height","STENCIL_INDEX8","targetTexture","render","data","readPixels","canvas","document","createElement","ctx","getContext","rowBytes","row","srow","imageData","createImageData","start","i","putImageData","dataURL","toDataURL"],"mappings":";;;;;;AAAA,IAAIA,WAAW,GAAGC,EAAE,CAACC,KAAH,CAAS;EACvB,WAASD,EAAE,CAACE,SADW;EAGvBC,OAAO,EAAE;IACLC,WAAW,EAAE,IADR;IAELC,aAAa,EAAE,yBAAW;MACtB,IAAIN,WAAW,CAACK,WAAZ,IAA2B,IAA/B,EAAqC;QACjCL,WAAW,CAACK,WAAZ,GAA0BJ,EAAE,CAACM,IAAH,CAAQ,oBAAR,EAA8BC,YAA9B,CAA2CP,EAAE,CAACQ,MAA9C,CAA1B;MACH;;MACD,OAAOT,WAAW,CAACK,WAAnB;IACH,CAPI;IASL;IACA;IACAK,mBAAmB,EAAE,6BAASC,MAAT,EAAiB;MAClC,IAAIC,OAAO,GAAG,IAAIX,EAAE,CAACY,aAAP,EAAd;MACA,IAAIC,EAAE,GAAGb,EAAE,CAACc,IAAH,CAAQC,cAAjB;MACAJ,OAAO,CAACK,YAAR,CAAqBhB,EAAE,CAACiB,WAAH,CAAeC,KAApC,EAA2ClB,EAAE,CAACiB,WAAH,CAAeE,MAA1D,EAAkEN,EAAE,CAACO,cAArE;MACAV,MAAM,CAACW,aAAP,GAAuBV,OAAvB;MACAD,MAAM,CAACY,MAAP;MACAZ,MAAM,CAACW,aAAP,GAAuB,IAAvB;MAEA,IAAIE,IAAI,GAAGZ,OAAO,CAACa,UAAR,EAAX;MAEA,IAAIC,MAAM,GAAGC,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAb;MACA,IAAIC,GAAG,GAAGH,MAAM,CAACI,UAAP,CAAkB,IAAlB,CAAV;MACAJ,MAAM,CAACP,KAAP,GAAeP,OAAO,CAACO,KAAvB;MACAO,MAAM,CAACN,MAAP,GAAgBR,OAAO,CAACQ,MAAxB;MAEA,IAAID,KAAK,GAAGP,OAAO,CAACO,KAApB;MACA,IAAIC,MAAM,GAAGR,OAAO,CAACQ,MAArB;MACA,IAAIW,QAAQ,GAAGZ,KAAK,GAAG,CAAvB;;MACA,KAAK,IAAIa,GAAG,GAAG,CAAf,EAAkBA,GAAG,GAAGZ,MAAxB,EAAgCY,GAAG,EAAnC,EAAuC;QACnC,IAAIC,IAAI,GAAGb,MAAM,GAAG,CAAT,GAAaY,GAAxB;QACA,IAAIE,SAAS,GAAGL,GAAG,CAACM,eAAJ,CAAoBhB,KAApB,EAA2B,CAA3B,CAAhB;QACA,IAAIiB,KAAK,GAAGH,IAAI,GAAGd,KAAP,GAAe,CAA3B;;QACA,KAAK,IAAIkB,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGN,QAApB,EAA8BM,CAAC,EAA/B,EAAmC;UAC/BH,SAAS,CAACV,IAAV,CAAea,CAAf,IAAoBb,IAAI,CAACY,KAAK,GAACC,CAAP,CAAxB;QACH;;QAEDR,GAAG,CAACS,YAAJ,CAAiBJ,SAAjB,EAA4B,CAA5B,EAA+BF,GAA/B;MACH;;MAED,IAAIO,OAAO,GAAGb,MAAM,CAACc,SAAP,CAAiB,YAAjB,CAAd;MACA,OAAOD,OAAP;IACH;EA1CI;AAHc,CAAT,CAAlB","sourceRoot":"/","sourcesContent":["var UtilsCommon = cc.Class({\n    extends: cc.Component,\n\n    statics: {\n        _cameraMain: null,\n        getCameraMain: function() {\n            if (UtilsCommon._cameraMain == null) {\n                UtilsCommon._cameraMain = cc.find(\"Canvas/Main Camera\").getComponent(cc.Camera);\n            }\n            return UtilsCommon._cameraMain;\n        },\n\n        //http://docs.cocos2d-x.org/creator/manual/zh/render/camera.html#截图\n        //https://github.com/cocos-creator/example-cases/blob/master/assets/cases/07_render_texture/render_to_canvas.js\n        getScreenshotBase64: function(camera) {\n            let texture = new cc.RenderTexture();\n            let gl = cc.game._renderContext;\n            texture.initWithSize(cc.visibleRect.width, cc.visibleRect.height, gl.STENCIL_INDEX8);\n            camera.targetTexture = texture;\n            camera.render();\n            camera.targetTexture = null;\n\n            let data = texture.readPixels();\n\n            let canvas = document.createElement('canvas');\n            let ctx = canvas.getContext('2d');\n            canvas.width = texture.width;\n            canvas.height = texture.height;\n\n            let width = texture.width;\n            let height = texture.height;\n            let rowBytes = width * 4;\n            for (let row = 0; row < height; row++) {\n                let srow = height - 1 - row;\n                let imageData = ctx.createImageData(width, 1);\n                let start = srow * width * 4;\n                for (let i = 0; i < rowBytes; i++) {\n                    imageData.data[i] = data[start+i];\n                }\n\n                ctx.putImageData(imageData, 0, row);\n            }\n\n            let dataURL = canvas.toDataURL(\"image/jpeg\");\n            return dataURL;\n        },\n    },\n});\n"]}